<!DOCTYPE html>

<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Faxina</title>

    <link rel="stylesheet" href="styles.css">

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";
      import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyAqSj6uOMqFuL3YoUxdgHZUil75ebPkNlU",
        authDomain: "agendamento-390700.firebaseapp.com",
        projectId: "agendamento-390700",
        storageBucket: "agendamento-390700.appspot.com",
        messagingSenderId: "1093556016847",
        appId: "1:1093556016847:web:e53f4c27cd2a21bfe449ba",
        measurementId: "G-L13DEMJPWB"
      };


      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      var availability = true;

      // Get a reference to the Firestore database
      const db = getFirestore();

      async function checkAvailability() {
        try {
            const day_wanted = document.getElementById("dayInput").value;
            
            const querySnapshot = await getDocs(collection(db, "Faxina"));
            var hasDuplicates = false; // Flag to track duplicates

            querySnapshot.forEach((doc) => {
              if (day_wanted === doc.data().day) {
                hasDuplicates = true;
              }
            });

            return !hasDuplicates;
        } catch (error) {
            console.error("Error retrieving contacts: ", error);
            throw error;
        }
      }

      // Function to add data to Firestore
      async function addData(name, phoneNumber, day) {
          try {
              const docRef = await addDoc(collection(db, "Faxina"), {
                  name: name,
                  phoneNumber: phoneNumber,
                  day: day,
              });
              console.log("Document added with ID: ", docRef.id);
              
          } catch (error) {
              console.error("Error adding document: ", error);
          }
      }

      // Call the function to add data when the form is submitted
      document.getElementById("contactForm").addEventListener("submit", async function (event) {
          event.preventDefault();
          const Apagar = document.getElementById("reset");
          const name = document.getElementById("nomeInput").value;
          const phoneNumber = document.getElementById("phoneNumberInput").value;
          const day = document.getElementById("dayInput").value;
         
          try {
              const isAvailable = await checkAvailability();

              if (isAvailable) {
                  
                addData(name, phoneNumber, day);
                  
                Apagar.click();
                
                const textoAlet = document.querySelector("#texto_alert");
                textoAlet.innerHTML = "Agendamento Confirmado <br><br> Press";
                
              } else {
                const alertBox = document.getElementById("alert");
                alertBox.style.visibility = "visible";
              }
          } catch (error) {
              console.error("Error checking availability: ", error);
          }
      });
  </script>
  </head>
  <body>
    <main>
      <div class="container">
        <header class="cabecalho">
          <h1 class="logo_container">
            <img src="./assets/logo.png" class="logo" />
          </h1>
          <h1 class="bem_vindo">bem vindo</h1>
          <h2 class="faca_ja_seu_agendamento">Faca já seu agendamento</h2>
        </header>
        
        <form class="container_form" id="contactForm">
          <div class="input_container">
            <label for="nomeInput" class="texto_input_padrao">Digite seu nome:</label>
            <input type="text" class="input_padrao" id="nomeInput" name="nomeInput" placeholder="João Maciel Da Silva" required>
          </div>

          <div class="input_container">
            <label for="phoneNumberInput" class="texto_input_padrao">Digite seu telefone de contato:</label>
            <input type="text" class="input_padrao" id="phoneNumberInput" name="phoneNumberInput" placeholder="(88) 9 9945-1245" required>
          </div>

          <div class="input_container">
            <label for="dayInput" class="texto_input_padrao">Dia desejado:</label>
            <input type="date" class="input_padrao" id="dayInput" name="dayInput:" placeholder="00 / 00 / 00" required>
          </div>

          <div class="box_botao">
            <button class="botao_agendar" type="submit">
              <p class="texto_agendar">Agendar</p>
            </button>
          </div>

          <button style="display: none;" id="reset" type="reset"></button>
        </form>
        
        <div id="alert" class="alert" onclick="hiddenAlertBox()">
          <h3 id="texto_alert" class="textoAlert">
            Sinto muito mais esse horario ja esta ocupado
            <br>
            <br>
            altere o horario ou entre em contato.
            <br>
            <br>
            <span class="textoAlertHelp">Press</span>
          </h3>
        </div>
      </div>
    </main>

  <script>
    var telefoneInput = document.getElementById('phoneNumberInput');

    telefoneInput.addEventListener('blur', function() {
      var numero = telefoneInput.value.replace(/\D/g, '');
      var formatado;

      if (numero.length === 11) {
        formatado = numero.substr(0, 2) + ' ' + numero.substr(2, 1) + ' ' + numero.substr(3, 4) + '-' + numero.substr(7, 4);
      } else {
        formatado = numero;
      }

      telefoneInput.value = formatado;
    });
  </script>
  <script>
    function hiddenAlertBox(){
      const alertBox = document.getElementById("alert");
      alertBox.style.visibility = "hidden";
      }
  </script>

  </body>
</html>